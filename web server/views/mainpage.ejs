<html>
<head>
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <link rel="stylesheet" type="text/css" href="css/bootstrap-theme.min.css">
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <script type="text/javascript" src="js/controller.js"></script>
  <script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/socket.io.js"></script>
  <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXSr2Q6-9b3gg83OJlHYYVrFGUbh1utEY">
  </script>
  <script type="text/javascript">
      var username = "<%=user%>";
      var socket = io.connect('http://limitless-savannah-8511.herokuapp.com');
      var devicesAgendas = {};
      var currentDevice= "";
      var currentTab = "agenda";
      socket.emit('webClientJoined', username);

      /******** DEVICE ADDED ********/
      socket.on('clientUpdateDevice', function(json)
      {
        currentDevice = json.id;
        var callDisplay = "<div style='position: fixed; top: 2em; right: 2em; display: visible;' id='callAlertContainer" + json.id + "'></div>";
        $('#page_wrapper').append(callDisplay);

        var newDevice = "<div class='list-group'><a href='#' id='userDeviceID" + json.id + "' class='list-group-item active'><h4 class='list-group-item-heading'>" + json.name + "</h4><p class='list-group-item-text' style='margin-bottom: 10px;' id='batteryID" + json.id + "'>Battery level: 0</p><ul class='list-group' style=' display: none; margin-bottom: 8px; padding-top: inherit'><li class= 'list-group-item' style='color: black; font-family: arial;'><span class='badge' id='smsBadge" + json.id + "'>0</span>Messages</li><li class='list-group-item' style='color: black; font-family: arial;'><span class='badge' id='notificationBadge" + json.id + "'>0</span>Notifications</li></ul></a></div>";
        $('#userDeviceList').append(newDevice);
        $('#userDeviceID' + json.id).attr("onclick","updatecurrentDevice('" + json.id + "');");
        var first = true;
        var agenda = {};
        try {
          agenda = JSON.parse(json.agenda);
        } catch (e) {
          console.log("ERR agenda", e);
          agenda = {};
        }

        devicesAgendas[json.id] = agenda;

        var agenda_array = [];
        for(var contact in agenda)
        {
          agenda_array.push({ key: contact, value: agenda[contact] });
        }
        console.log(agenda_array);
        agenda_array = agenda_array.sort(function(a, b)
        {
          if( a['value'] > b['value'])
          {
              return 1;
          }else if( a['value'] < b['value'] )
          {
              return -1;
          }
          return 0;
        });
        console.log("SORTED", agenda_array);

        //agenda wrapper
        // var agenda_wrapper = "<div class='agenda_window' id='agenda_window" + json.id + "'> <div class='chat-container' id='agenda_window" + json.id +"'>";
        var agenda_wrapper = "<div class='agenda_window' id='agenda_window" + json.id + "'> <div class='chat-container' id='agenda_window" + json.id +"'>";
        for(var i = 0; i < agenda_array.length; i++)
        {
          if(first)
          {
            first = false;
            agenda_wrapper +=   "<div class='panel-body chat-box' id='chat-box" + json.id + agenda_array[i]['key'] + "' style='display: visible;'></div><div class='chat-box-footer' id='chat-box-footer" + json.id + agenda_array[i]['key'] + "' style='display: visible;'>";
          }
          else {
            agenda_wrapper +=   "<div class='panel-body chat-box' id='chat-box" + json.id + agenda_array[i]['key'] + "' style='display: none;'></div><div class='chat-box-footer' id='chat-box-footer" + json.id + agenda_array[i]['key'] + "' style='display: none;'>";
          }
            agenda_wrapper += "<div class='input-group' style='margin: 4px;'><input type='text' class='form-control' placeholder='Enter Text Here...' id='input" + json.id + agenda_array[i]['key'] + "'><span class='input-group-btn'><button class='btn btn-info' id='button-send" + json.id + agenda_array[i]['key'] + "' type='button'>SEND</button></span></div></div>";
        }
        agenda_wrapper += "</div><div class='agenda_list' id='agenda_list" + json.id + "'><ul class='list-group' style='overflow: auto;' id='contact_list" + json.id + "'></ul></div></div>";
        $('#right_sidebar_agenda').append(agenda_wrapper);

        first = true;

        //add send button function
        for(var contact in agenda)
        {
          $('#button-send' + json.id + contact).attr("onclick","sendMessage('" + json.id + "','" + contact + "');");
        }

        //fill agenda
        for(var i = 0; i < agenda_array.length; i++)
        {
          if(first)
          {
            first = false;
            $('#contact_list' + json.id).append("<li class='list-group-item active' style='color: white;' id='contact_item" + json.id + agenda_array[i]['key'] + "'> <a style='color: inherit;'>" + agenda_array[i]['value'] + "</a><img src='img/red_dot.png' style='display: none' class='red_dot'><p style='display: none' id='unread" + json.id + agenda_array[i]['key'] + "'>0</p></li>");
          }
          else {
            $('#contact_list' + json.id).append("<li class='list-group-item' style='color: #337ab7;' id='contact_item" + json.id + agenda_array[i]['key'] + "'> <a style='color: inherit;'>" + agenda_array[i]['value'] + "</a><img src='img/red_dot.png' style='display: none' class='red_dot'><p style='display: none' id='unread" + json.id + agenda_array[i]['key'] + "'>0</p></li>");
          }
          $('#contact_item'+json.id+agenda_array[i]['key']).attr("onclick","changeChat('" + json.id + "','" + agenda_array[i]['key'] + "');");
        }

        var notificationWrapper = "<div id='notification_window" + json.id + "' style='display:visible'><ul class='list-group notif_stack' id='stack" + json.id + "' style='overflow: auto; width: 70%; height: 100%;'></ul><button class='btn btn-default' style='margin-left: 85%; margin-top: -600px;' id='dismissNotifBtn" + json.id + "'>Dismiss All</button></div>";
        $('#right_sidebar_notification').append(notificationWrapper);
        $('#dismissNotifBtn' + json.id).attr("onclick", "dismissAllNotif('" + json.id + "')");

        var logWrapper = "<div id='calllog_window" + json.id + "' style='display: visible'><ul class='list-group notif_stack' id='logstack" + json.id + "' style='overflow: auto; width: 70%; height: 100%'></ul><button class='btn btn-default' style='margin-left: 85%; margin-top: -600px;' id='dismissAllCallsBtn" + json.id + "'>Dismiss All</button></div>";
        $('#right_sidebar_calllog').append(logWrapper);
        $('#dismissAllCallsBtn' + json.id).attr("onclick", "dismissAllCalls('" + json.id + "')");

        var locationWrapper = "<div id='location" + json.id + "' style='display: visible; width:100%; height: 100%'><div id='map-canvas'></div></div>";
        $('#right_sidebar_location').append(locationWrapper);

        var settingsWrapper = "<div id='settings" + json.id + "' style='display: visible; height: inherit;'><div style='height: 100%; width: 100%;'><ul style='margin: auto; width: 50%;' class='list-group checked-list-box' id='settings" + json.id + "'><li class='list-group-item'>Receive SMS<input style='margin-left: -98px' type='checkbox'  id='receiveSMScheckbox" + json.id + "'></li><li class='list-group-item'>Send SMS<input style='margin-left: -80px' type='checkbox' id='sendSMScheckbox" + json.id + "'></li><li class='list-group-item'>Receive Push notifications<input style='margin-left: -179px' type='checkbox' id='notificationcheckbox" + json.id + "'></li><li class='list-group-item'>Receive last known location<input style='margin-left: -188px' type='checkbox' id='locationcheckbox" + json.id + "'></li><li class='list-group-item'>Receive missed calls<input style='margin-left: -145px' type='checkbox' id='calllogcheckbox" + json.id + "'></li></ul><button class='btn btn-default' style='margin-top: -370px; margin-left: 40%;' id='savesettings" + json.id + "'>Save settings</button></div></div>";
        $('#right_sidebar_settings').append(settingsWrapper);
        $('#savesettings' + json.id).attr("onclick","saveSettings('" + json.id + "')");
      });

      /******** DEVICE REMOVED ********/
      socket.on('clientRemoveDevice', function(json)
      {
        $('#userDeviceID' + json.id).remove();
        location.reload();
      });

      /******** RECEIVE BATTERY STATUS FROM PHONE ********/
      socket.on('clientUpdateBattery', function (json)
      {
        $('#batteryID' + json.deviceID).text('Battery level: ' + json.battery);
      });

      /******** RECEIVE NOTIFICATION FROM PHONE ********/
      socket.on('clientReceivedNotification', function(data)
      {
        var countSoFar = parseInt($('#device' + currentDevice + 'NotificationCount').text());
        console.log("COUNT1", countSoFar);
        countSoFar = countSoFar + 1;
        console.log("COUNT2", countSoFar);
        $('#devicedata.idNotificationCount').text(countSoFar);
        var components = data.split("|");
        var package_split = components[2].split(".");
        var entry = "<li class='list-group-item' id='notif" + components[0] + components[1] + "'><span class='badge'>click to dismiss</span><h4>App package " + package_split[2] + " with title " + components[3] + "</h4>" + components[4] + "</li>";
        $('#stack' + components[0]).prepend(entry);
        $('#notif' + components[0] + components[1]).attr("onclick","dismissNotif('" + components[0] + "','" + components[1] + "|" + components[2] + "|" + components[3] + "|" + components[4] +  "');");
      });

      socket.on('notificationsList', function(array)
      {
        for( var i = 0; i < array.length; i++)
        {
          $('#devicedata.idNotificationCount').text(parseInt($('#devicedata.idNotificationCount').text()) + 1);
          var string = array[i]['notification'];
          var components = string.split("|");
          var package_split = components[1].split(".");
          var entry = "<li class='list-group-item' id='notif" + array[i]['id'] + components[0] + "'><span class='badge'>click to dismiss</span><h4>App package " + package_split[2] + " with title: " + components[2] + "</h4>" + components[3] + "</li>";
          $('#stack' + array[i]['id']).prepend(entry);
          $('#notif' + array[i]['id'] + components[0]).attr("onclick","dismissNotif('" + array[i]['id'] + "','" + components[0] + "|" + components[1] + "|" + components[2] + "|" + components[3] +  "');");
        }
      });

      /******** RECEIVE SMS FROM PHONE ********/
      socket.on('clientReceivedMessage', function(data)
      {
        data.contact = data.contact.replace(" ","");
        data.contact = data.contact.replace("+","");
        data.contact = data.contact.replace("-","");
        data.contact = data.contact.substring(1);
        console.log('message', data);
        var found = false;
        for(var device in devicesAgendas)
        {
          if(device == data.id)
          {
            for(var person in devicesAgendas[device])
            {
              if(person == data.contact)
              {
                console.log("CONTACT IN SAVED AGENDA");
                found = true;
              }
            }
          }
        }
        if(!found)
        {
          console.log("contact care nu e in agenda");
          //il adaugam in agenda mare
          devicesAgendas[data.id][data.contact] = data.contact;
          //insert new chat box
          var cbox = "<div class='panel-body chat-box' id='chat-box" + data.id + data.contact + "' style='display: none;'></div>";
          $('#agenda_window'+data.id).append(cbox);
          //insert input
          var inp = "<div class='chat-box-footer' id='chat-box-footer" + data.id + data.contact + "' style='display: none;'><div class='input-group' style='margin: 4px;'><input type='text' class='form-control' placeholder='Enter Text Here...' id='input" + data.id + data.contact + "'><span class='input-group-btn'><button class='btn btn-info' id='button-send" + data.id + data.contact + "' type='button'>SEND</button></span></div></div>";
          $('#agenda_window'+data.id).append(inp);
          //insert onclick for send button
          $('#button-send' + data.id + data.contact).attr("onclick", "sendMessage('" + data.id + "','" + data.contact + "');");
          //insert new agenda entry
          var agenda_entry = "<li class='list-group-item' style='color: #337ab7;' id='contact_item" + data.id + data.contact + "'><a style='color: inherit;'>" + data.contact + "</a><img src='img/red_dot.png' class='red_dot' style='display: none'><p id='unread" + data.id + data.contact + "' style='display: none'>0</p></li>";
          $('#contact_list' + data.id).append(agenda_entry);
          //insert onclick for agenda entry
          $('#contact_item'+data.id+data.contact).attr("onclick", "changeChat('" + data.id + "','" + data.contact + "');");
        }
        postMessage(data.id, data.contact, data.message);
        postMessageNotification(data.id, data.contact);
        modifyCounter(data.id);
      });

      socket.on('clientReceivedLocation', function(data)
      {
        var latStr = data.lat;
        var longStr = data.long;
        var longitude = parseFloat(longStr);
        var latitude = parseFloat(latStr);
        var myLatlng = new google.maps.LatLng(longitude,latitude);
        var mapOptions =
        {
          center: { lat: longitude, lng: latitude},
          zoom: 15
        };
        // $('#map-canvas').empty();
        // console.log("SUNT AICI ODATA");
        var map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);
        var marker = new google.maps.Marker({
           position: myLatlng,
           map: map,
           title: 'Last location'
        });
      });

      /******** RECEIVE CALL FROM PHONE ********/
      socket.on('clientReceivedCall', function(data)
      {
        console.log('call from: ', data);

      });

      /* UPDATE SETTINGS IN CLIENT */
      socket.on('new_settings', function(settings)
      {
        json = JSON.parse(settings);
        $('#receiveSMScheckbox' + currentDevice).attr('checked', json['fwd']);
        $('#sendSMScheckbox' + currentDevice).attr('checked', json['snd']);
        $('#notificationcheckbox' + currentDevice).attr('checked', json['psh']);
        $('#locationcheckbox' + currentDevice).attr('checked', json['fmd']);
        $('#calllogcheckbox' + currentDevice).attr('checked', json['fmr']);
      });

      /* UPDATE CALL LOG IN CLIENT */
      socket.on('forwardPhonecall', function(data)
      {
        $('#devicedata.idNotificationCount').text(parseInt($('#devicedata.idNotificationCount').text()) + 1);

        var dateString = new Date(data['timestamp']);

        var person = $('#contact_item' + data['device'] + data['number'] + " a").text();

        var entry = "<li class='list-group-item' id='log" + data['device'] + data['number'] + data['timestamp'] + "'><span class='badge'>dismiss</span><h4>Missed call from " + person + "</h4> at " + dateString + "</li>";
        $('#logstack' + data['device']).prepend(entry);
        $('#log' + data['device'] + data['number'] + data['timestamp']).attr("onclick","dismissLogEntry('" + data['device'] + "','" + data['number'] + "|" + data['timestamp'] +  "');");
        console.log("DATA NON FUCKED UP", data['timestamp']);
        var ringing = "<div class='alert alert-success' id='callAlertItem" + data['number'] + "'>Call from:" + person + "<span class='badge' id='dismissbadge" + data['number'] + "'>REJECT</span></div>";
        $('#callAlertContainer' + data['device']).prepend(ringing);
        $('#dismissbadge' + data['number']).attr("onclick","rejectCall('" + data['device'] + "','" + data['number'] + "')");
      });

      socket.on('loglist', function(data)
      {
        for( var i = 0; i < data.length; i++)
        {
          $('#devicedata.idNotificationCount').text(parseInt($('#devicedata.idNotificationCount').text()) + 1);
          var obj = data[i];
          var dateString = new Date(obj['timestamp']);
          console.log(obj['timestamp']);
          var person = $('#contact_item' + data[i]['id'] + data[i]['log'] + " a").text();

          var entry = "<li class='list-group-item' id='log" + data[i]['id'] + data[i]['log'] + data[i]['timestamp'] + "'><span class='badge'>dismiss</span><h4>Missed call from " + person + "</h4> at " + dateString + "</li>";
          $('#logstack' + data[i]['id']).prepend(entry);
          $('#log' + data[i]['id'] + data[i]['log'] + data[i]['timestamp']).attr("onclick","dismissLogEntry('" + data[i]['id'] + "','" + data[i]['log'] + "|" + data[i]['timestamp'] +  "');");
        }
      });

      /******** JAVASCRIPT FUNCTIONS ********/
      function rejectCall(deviceID, number)
      {
        console.log('rejecting', number);
        $('#callAlertItem' + number).remove();
        socket.emit('rejectCall',number);
      }

      function changeChat(deviceID, contactID)
      {
        $('#contact_list' + deviceID + ' .active').css("color", "#337ab7"); //sterg culoarea
        $('#contact_list' + deviceID + " .active").removeClass("active"); //sterg active
        $('#contact_item' + deviceID + contactID + ' img').hide(); //ascund notificarea
        $('#contact_item' + deviceID + contactID).addClass('active'); //adaug active
        $('#contact_item' + deviceID + contactID).css("color","black"); // adaug scris alb

        //modify notification counter
        var unread_to_be_read = $('#unread' + deviceID + contactID).val();
        console.log("UNREAD messages ", unread_to_be_read);
        $('#unread'+deviceID+contactID).val(0);
        $('#smsBadge' + deviceID).val($('#smsBadge'+deviceID).val() - unread_to_be_read);

        //disable ex-chat window
        $('.chat-box:visible').css('display', 'none');
        //enable new chat windw
        $('#chat-box' + deviceID + contactID).show();

        $('.chat-box-footer:visible').css('display', 'none');
        $('#chat-box-footer' + deviceID + contactID).show();
      }

      function sendMessage(deviceID, contactID)
      {
        var sentMessage ="<div class='chat-box-message'><p>" + $('#input' + deviceID + contactID).val() + "</p><div style='clear: both;'></div></div>";
        $('#chat-box'+deviceID+contactID).append(sentMessage);
        var message = $('#input' + deviceID + contactID).val();
        socket.emit('sendSmsTo', { 'device' : deviceID, 'contact': contactID, 'message' : message});
        $('#input' + deviceID + contactID).val("");
      }

      function postMessage(deviceID, contactID, message)
      {
        console.log("AM PRIMIT MESAJ ", deviceID);
        console.log("PENTRU", contactID);
        var postMessage = "<div class='chat-box-message' style='background-color: #FFE6B8;'><p style='float: right; position: relative; bottom: 7px;'>" + message + "</p><div style='cloear: both;'></div></div>";
        $('#chat-box' + deviceID + contactID).append(postMessage);
      }

      function postMessageNotification(deviceID, contactID)
      {
        //verifica intai daca nu e deja active
        if( ! $('#contact_item' + deviceID + contactID).hasClass('active') )
        {
          $('#contact_item' + deviceID + contactID + ' img').show();
        }
      }

      function changeScreen(curWindow)
      {
        currentTab = curWindow;
        $('#navBar li.active').removeClass('active');
        $('#' + curWindow + "Option").addClass('active');
        if(curWindow == "agenda")
        {
          $('#right_sidebar_agenda').show();
          $('#right_sidebar_notification').hide();
          $('#right_sidebar_calllog').hide();
          $('#right_sidebar_location').hide();
          $('#right_sidebar_settings').hide();
        }
        else if(curWindow == "notification")
        {
          $('#stack' + currentDevice).empty();
          socket.emit('fetchNotifications',{'device':currentDevice});
          $('#right_sidebar_agenda').hide();
          $('#right_sidebar_notification').show();
          $('#right_sidebar_calllog').hide();
          $('#right_sidebar_location').hide();
          $('#right_sidebar_settings').hide();
        }
        else if (curWindow == 'callLog')
        {
          $('#logstack' + currentDevice).empty();
          socket.emit('fetchLog',{'device':currentDevice});
          $('#right_sidebar_agenda').hide();
          $('#right_sidebar_notification').hide();
          $('#right_sidebar_calllog').show();
          $('#right_sidebar_location').hide();
          $('#right_sidebar_settings').hide();
        }
        else if(curWindow == "location")
        {
          $('#right_sidebar_agenda').hide();
          $('#right_sidebar_notification').hide();
          $('#right_sidebar_calllog').hide();
          $('#right_sidebar_location').show();
          $('#right_sidebar_settings').hide();
          //init google maps
          socket.emit('webClientGetLocation', {'user': username, 'device' : currentDevice});
        }
        else if(curWindow == "settings")
        {
          $('#right_sidebar_agenda').hide();
          $('#right_sidebar_notification').hide();
          $('#right_sidebar_calllog').hide();
          $('#right_sidebar_location').hide();
          $('#right_sidebar_settings').show();
          socket.emit('request_settings', {'id' : currentDevice});
        }
        else if(curWindow == "disconnect")
        {
          //disconnect from server
          //close the socket
        }
      }

      function dismissNotif(deviceID, notification)
      {
        var parts = notification.split("|");
        socket.emit('removeNotification', { 'notif': notification});
        $('#notif' + deviceID + parts[0]).remove();
      }

      function dismissAllNotif(deviceID)
      {
        socket.emit('removeNotification', {'device': deviceID, 'notif': 'all'});
        $('#stack' + deviceID).empty();
      }

      function dismissAllCalls(deviceID)
      {
        socket.emit('removeLogEntry', {'device' : deviceID, 'number' : 'all'});
        $('#logstack' + deviceID).empty();
      }

      function dismissLogEntry(deviceID, entry)
      {
        var parts = entry.split("|");
        socket.emit('removeLogEntry', {'device' : deviceID, 'number' : entry[0], 'timestamp' : entry[1]});
        $('#log' + deviceID + parts[0] + parts[1]).remove();
      }

      function saveSettings(deviceID)
      {
        var json = {};
        if ($('#receiveSMScheckbox' + currentDevice).is(":checked"))
        {
          json['fwd'] = true;
        }
        else {
          json['fwd'] = false;
        }
        if ($('#sendSMScheckbox' + currentDevice).is(":checked"))
        {
          json['snd'] = true;
        }
        else {
          json['snd'] = false;
        }
        if ($('#notificationcheckbox' + currentDevice).is(":checked"))
        {
          json['psh'] = true;
        }
        else {
          json['psh'] = false;
        }
        if ($('#locationcheckbox' + currentDevice).is(":checked"))
        {
          json['fmd'] = true;
        }
        else {
          json['fmd'] = false;
        }
        if ($('#calllogcheckbox' + currentDevice).is(":checked"))
        {
          json['fmr'] = true;
        }
        else {
          json['fmr'] = false;
        }
        socket.emit('webClientChangeSettings', {'device' : deviceID, 'settings' : json});
      }

      function modifyCounter(deviceID)
      {
        $('#smsBadge' + deviceID).val($('#smsBadge' + deviceID).val() + 1);
        console.log("MODIFIC VAL", $('#smsBadge'+deviceID).val());
      }

      function updatecurrentDevice(newID)
      {
        console.log("ACTIVE DEVICE ", newID);
        $('#' + currentTab + '_window' + currentDevice).hide();
        currentDevice = newID;
        $('#agenda_window' + currentDevice).show();
      }

      $(document).ready(function()
      {
      });
  </script>
</head>
<body>
  <% include body.ejs %>
</body>
</html>
